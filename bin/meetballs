#!/usr/bin/env bash
set -euo pipefail

VERSION="0.1.0"

# Resolve LIB_DIR relative to the script's real path (follows symlinks)
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# Source shared utilities
source "$LIB_DIR/common.sh"

show_banner() {
    local banner="$LIB_DIR/banner.ansi"
    if [[ -t 1 ]] && [[ -f "$banner" ]]; then
        cat "$banner"
    fi
}

show_help() {
    show_banner
    cat <<'EOF'
Usage: meetballs <command> [args...]

Commands:
  live         Start a live transcription session with Q&A
  hist         Browse session history (interactive TUI)
  clean        Remove recordings to reclaim disk space
  record       Record meeting audio from the microphone
  transcribe   Transcribe a recording to text
  ask          Ask questions about a transcript
  logs         View session logs and diagnostic dumps
  update       Pull latest code and check for rebuild needs
  doctor       Check dependencies and system readiness

Options:
  --help       Show this help message
  --version    Show version

Run 'meetballs <command> --help' for more information on a command.
EOF
}

case "${1:-}" in
    --help|"")
        show_help
        ;;
    --version)
        echo "meetballs $VERSION"
        ;;
    live)
        shift
        source "$LIB_DIR/live.sh"
        cmd_live "$@"
        ;;
    record)
        shift
        source "$LIB_DIR/record.sh"
        cmd_record "$@"
        ;;
    transcribe)
        shift
        source "$LIB_DIR/transcribe.sh"
        cmd_transcribe "$@"
        ;;
    ask)
        shift
        source "$LIB_DIR/ask.sh"
        cmd_ask "$@"
        ;;
    hist)
        shift
        source "$LIB_DIR/hist.sh"
        cmd_hist "$@"
        ;;
    clean)
        shift
        source "$LIB_DIR/clean.sh"
        cmd_clean "$@"
        ;;
    list)
        mb_warn "'meetballs list' is deprecated. Use 'meetballs hist' instead."
        exit 0
        ;;
    logs)
        shift
        source "$LIB_DIR/logs.sh"
        cmd_logs "$@"
        ;;
    update)
        shift
        source "$LIB_DIR/doctor.sh"
        source "$LIB_DIR/update.sh"
        cmd_update "$@"
        ;;
    doctor)
        shift
        source "$LIB_DIR/doctor.sh"
        cmd_doctor "$@"
        ;;
    *)
        mb_error "Unknown command: $1"
        mb_error "Run 'meetballs --help' for usage."
        exit 1
        ;;
esac
